<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Formular Generierung</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        .info {
            color: blue;
        }
        #results {
            margin-top: 20px;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        pre {
            background-color: #eee;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Test: Formular-Generierung für Unterschwellige Vergabe</h1>
    
    <div class="test-section">
        <h2>1. Login Test</h2>
        <button onclick="testLogin()">Login testen</button>
        <div id="loginResult"></div>
    </div>

    <div class="test-section">
        <h2>2. Projekt erstellen</h2>
        <button onclick="createProject()">Projekt erstellen</button>
        <div id="projectResult"></div>
    </div>

    <div class="test-section">
        <h2>3. Templates abrufen</h2>
        <button onclick="loadTemplates()">Templates laden</button>
        <div id="templateResult"></div>
    </div>

    <div class="test-section">
        <h2>4. Formularfelder prüfen</h2>
        <button onclick="checkFormFields()">Felder überprüfen</button>
        <div id="fieldsResult"></div>
    </div>

    <div id="results">
        <h2>Test-Ergebnisse:</h2>
        <div id="summary"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:8091/api';
        let authToken = '';
        let currentProjectId = '';
        let templates = [];

        async function testLogin() {
            const resultDiv = document.getElementById('loginResult');
            try {
                const response = await fetch(`${API_URL}/collections/users/auth-with-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        identity: 'testuser@example.com',
                        password: 'testpass123'
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    authToken = data.token;
                    resultDiv.innerHTML = '<p class="success">✓ Login erfolgreich</p>';
                    addToSummary('Login: Erfolgreich', 'success');
                } else {
                    resultDiv.innerHTML = `<p class="error">✗ Login fehlgeschlagen: ${data.message}</p>`;
                    addToSummary('Login: Fehlgeschlagen', 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">✗ Fehler: ${error.message}</p>`;
                addToSummary('Login: Fehler', 'error');
            }
        }

        async function createProject() {
            const resultDiv = document.getElementById('projectResult');
            if (!authToken) {
                resultDiv.innerHTML = '<p class="error">✗ Bitte zuerst einloggen</p>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/collections/projects/records`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: 'Test Projekt Unterschwellig',
                        description: 'Testprojekt für unterschwellige Vergabe',
                        procurement_type: 'Dienst',
                        threshold_type: 'unterschwellig',
                        status: 'draft',
                        form_data: {},
                        user: getUserIdFromToken(authToken)
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    currentProjectId = data.id;
                    resultDiv.innerHTML = `<p class="success">✓ Projekt erstellt (ID: ${data.id})</p>`;
                    addToSummary('Projekt erstellen: Erfolgreich', 'success');
                } else {
                    resultDiv.innerHTML = `<p class="error">✗ Fehler: ${JSON.stringify(data)}</p>`;
                    addToSummary('Projekt erstellen: Fehlgeschlagen', 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">✗ Fehler: ${error.message}</p>`;
                addToSummary('Projekt erstellen: Fehler', 'error');
            }
        }

        async function loadTemplates() {
            const resultDiv = document.getElementById('templateResult');
            if (!authToken) {
                resultDiv.innerHTML = '<p class="error">✗ Bitte zuerst einloggen</p>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/collections/templates/records?filter=${encodeURIComponent('active=true')}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                if (response.ok) {
                    templates = data.items;
                    const uvgoTemplates = templates.filter(t => t.category === 'UVgO' || t.category === 'VgV_UVgO');
                    
                    resultDiv.innerHTML = `
                        <p class="success">✓ ${uvgoTemplates.length} UVgO Templates gefunden:</p>
                        <ul>
                            ${uvgoTemplates.map(t => `<li>${t.name} (${t.category})</li>`).join('')}
                        </ul>
                    `;
                    addToSummary(`Templates: ${uvgoTemplates.length} UVgO Templates gefunden`, 'success');
                } else {
                    resultDiv.innerHTML = `<p class="error">✗ Fehler: ${data.message}</p>`;
                    addToSummary('Templates laden: Fehlgeschlagen', 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">✗ Fehler: ${error.message}</p>`;
                addToSummary('Templates laden: Fehler', 'error');
            }
        }

        async function checkFormFields() {
            const resultDiv = document.getElementById('fieldsResult');
            if (templates.length === 0) {
                resultDiv.innerHTML = '<p class="error">✗ Bitte zuerst Templates laden</p>';
                return;
            }

            const uvgoTemplates = templates.filter(t => t.category === 'UVgO' || t.category === 'VgV_UVgO');
            const allFields = {};
            
            uvgoTemplates.forEach(template => {
                if (template.template_fields) {
                    Object.entries(template.template_fields).forEach(([key, field]) => {
                        if (!allFields[key]) {
                            allFields[key] = field;
                        }
                    });
                }
            });

            const fieldsByType = {};
            Object.entries(allFields).forEach(([key, field]) => {
                const type = field.type || 'text';
                if (!fieldsByType[type]) {
                    fieldsByType[type] = [];
                }
                fieldsByType[type].push({ key, ...field });
            });

            let html = '<h3>Gefundene Formularfelder:</h3>';
            
            Object.entries(fieldsByType).forEach(([type, fields]) => {
                html += `<h4>${type} (${fields.length} Felder):</h4><ul>`;
                fields.forEach(field => {
                    html += `<li><strong>${field.label}</strong> (${field.key})${field.required ? ' *' : ''}</li>`;
                });
                html += '</ul>';
            });

            // Prüfe spezifische Feldtypen
            const checks = {
                'Textfelder': fieldsByType.text?.length > 0,
                'Datumsfelder': fieldsByType.date?.length > 0 || fieldsByType.datetime?.length > 0,
                'Währungsfeld': fieldsByType.currency?.length > 0,
                'Checkboxen': fieldsByType.checkbox?.length > 0,
                'Select-Felder': fieldsByType.select?.length > 0
            };

            html += '<h3>Feldtypen-Prüfung:</h3><ul>';
            Object.entries(checks).forEach(([type, exists]) => {
                html += `<li class="${exists ? 'success' : 'error'}">${exists ? '✓' : '✗'} ${type}</li>`;
                addToSummary(`${type}: ${exists ? 'Vorhanden' : 'Fehlt'}`, exists ? 'success' : 'error');
            });
            html += '</ul>';

            resultDiv.innerHTML = html;
        }

        function getUserIdFromToken(token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                return payload.id;
            } catch {
                return null;
            }
        }

        function addToSummary(text, type) {
            const summaryDiv = document.getElementById('summary');
            const entry = document.createElement('p');
            entry.className = type;
            entry.textContent = text;
            summaryDiv.appendChild(entry);
        }
    </script>
</body>
</html>